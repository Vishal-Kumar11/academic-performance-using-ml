{% extends "base.html" %}

{% block title %}Batch Predictions - AcademicInsight ML{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="fw-bold mb-3">
                    <i class="bi bi-upload text-primary me-3"></i>
                    Batch Predictions
                </h1>
                <p class="text-muted fs-5">
                    Process multiple students at once with CSV file upload
                </p>
            </div>

            <!-- Upload Section -->
            <div class="card shadow-lg border-0 mb-5">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-cloud-upload me-2"></i>
                        Upload CSV File
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="batchForm" method="POST" action="{{ url_for('batch_predictions') }}" enctype="multipart/form-data" class="needs-validation" novalidate>
                        <!-- File Upload Area -->
                        <div class="file-upload-area mb-4" id="fileUploadArea">
                            <div class="text-center">
                                <i class="bi bi-cloud-upload text-primary mb-3" style="font-size: 3rem;"></i>
                                <h5 class="mb-3">Drag & Drop CSV File Here</h5>
                                <p class="text-muted mb-3">or click to browse files</p>
                                <input type="file" id="csvFile" name="csvFile" accept=".csv" class="d-none" required>
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('csvFile').click()">
                                    <i class="bi bi-folder2-open me-2"></i>
                                    Choose File
                                </button>
                            </div>
                        </div>

                        <!-- File Preview -->
                        <div id="filePreview" class="file-preview mb-4" style="display: none;"></div>

                        <!-- Sample Download -->
                        <div class="text-center mb-4">
                            <p class="text-muted mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Need a sample file? Download our template to see the required format.
                            </p>
                            <button type="button" class="btn btn-outline-info" onclick="downloadSample()">
                                <i class="bi bi-download me-2"></i>
                                Download Sample CSV
                            </button>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                <i class="bi bi-play-circle me-2"></i>
                                Process Batch Predictions
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Instructions -->
            <div class="row mb-5">
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-list-check me-2"></i>
                                Required Columns
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <code>gender</code> - male or female
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <code>race_ethnicity</code> - group A, B, C, D, or E
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <code>parental_level_of_education</code> - education level
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <code>lunch</code> - free/reduced or standard
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <code>test_preparation_course</code> - none or completed
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <code>reading_score</code> - 0 to 100
                                </li>
                                <li>
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <code>writing_score</code> - 0 to 100
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Important Notes
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="bi bi-arrow-right text-warning me-2"></i>
                                    Maximum 1000 records per batch
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-arrow-right text-warning me-2"></i>
                                    CSV must have headers
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-arrow-right text-warning me-2"></i>
                                    All columns are required
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-arrow-right text-warning me-2"></i>
                                    Scores must be 0-100 range
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-arrow-right text-warning me-2"></i>
                                    Processing time: ~2-5 seconds
                                </li>
                                <li>
                                    <i class="bi bi-arrow-right text-warning me-2"></i>
                                    Results downloadable as CSV
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="batchResults" class="mb-5" style="display: none;"></div>

            <!-- Processing Information -->
            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Processing Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-number text-primary">13</div>
                            <div class="stat-label">ML Models</div>
                            <div class="stat-description">Used for prediction</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-number text-success">94.2%</div>
                            <div class="stat-label">Accuracy</div>
                            <div class="stat-description">Best model performance</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-number text-info">1000</div>
                            <div class="stat-label">Max Records</div>
                            <div class="stat-description">Per batch processing</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-number text-warning">5-Fold</div>
                            <div class="stat-label">CV</div>
                            <div class="stat-description">Cross validation</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Sample CSV content
    const sampleCSV = `gender,race_ethnicity,parental_level_of_education,lunch,test_preparation_course,reading_score,writing_score
male,group B,bachelor's degree,standard,none,72,74
female,group C,some college,free/reduced,completed,90,88
male,group A,master's degree,standard,completed,85,87
female,group D,high school,free/reduced,none,65,68
male,group E,associate's degree,standard,completed,78,80`;

    function downloadSample() {
        const blob = new Blob([sampleCSV], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sample_academic_data.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast('Sample CSV downloaded!', 'success');
    }

    // Enhanced file upload handling
    document.addEventListener('DOMContentLoaded', function() {
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('csvFile');
        const filePreview = document.getElementById('filePreview');
        const submitBtn = document.getElementById('submitBtn');

        // Drag and drop functionality
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                fileInput.files = files;
                updateFilePreview(files[0]);
            } else {
                showToast('Please upload a CSV file only.', 'error');
            }
        });

        // Click to upload
        fileUploadArea.addEventListener('click', function() {
            fileInput.click();
        });

        // File input change
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                const file = this.files[0];
                if (file.type === 'text/csv') {
                    updateFilePreview(file);
                } else {
                    showToast('Please select a CSV file.', 'error');
                    this.value = '';
                }
            }
        });

        // Form submission
        document.getElementById('batchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!fileInput.files.length) {
                showToast('Please select a CSV file to upload.', 'error');
                return;
            }

            // Show loading state
            const hideLoading = showLoading(submitBtn);
            
            // Simulate processing (replace with actual AJAX call)
            setTimeout(() => {
                hideLoading();
                showBatchResults();
            }, 3000);
        });
    });

    function updateFilePreview(file) {
        const filePreview = document.getElementById('filePreview');
        const fileUploadArea = document.getElementById('fileUploadArea');
        
        filePreview.innerHTML = `
            <div class="d-flex align-items-center p-3 bg-light rounded">
                <i class="bi bi-file-earmark-csv text-success fs-3 me-3"></i>
                <div class="flex-grow-1">
                    <h6 class="mb-1">${file.name}</h6>
                    <small class="text-muted">${(file.size / 1024).toFixed(1)} KB • CSV File</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        
        filePreview.style.display = 'block';
        fileUploadArea.style.display = 'none';
    }

    function clearFile() {
        const fileInput = document.getElementById('csvFile');
        const filePreview = document.getElementById('filePreview');
        const fileUploadArea = document.getElementById('fileUploadArea');
        
        fileInput.value = '';
        filePreview.style.display = 'none';
        fileUploadArea.style.display = 'block';
    }

    function showBatchResults() {
        const resultsContainer = document.getElementById('batchResults');
        resultsContainer.innerHTML = `
            <div class="card shadow-lg border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        Batch Processing Complete!
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h6 class="text-success mb-2">
                                <i class="bi bi-check-circle me-2"></i>
                                Successfully processed 150 student records
                            </h6>
                            <p class="text-muted mb-0">
                                All predictions completed with high confidence. 
                                Download the results CSV file to view detailed predictions.
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <button class="btn btn-success btn-lg" onclick="downloadResults()">
                                <i class="bi bi-download me-2"></i>
                                Download Results
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-number text-primary">150</div>
                                <div class="stat-label">Records Processed</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-number text-success">94.2%</div>
                                <div class="stat-label">Average Accuracy</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-number text-info">2.3s</div>
                                <div class="stat-label">Processing Time</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-number text-warning">85.7</div>
                                <div class="stat-label">Avg Predicted Score</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        resultsContainer.style.display = 'block';
        resultsContainer.classList.add('fade-in');
    }

    function downloadResults() {
        showToast('Download started!', 'success');
        // Implement actual download functionality
    }
</script>
{% endblock %}
